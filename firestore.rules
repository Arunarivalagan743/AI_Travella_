rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Common functions for reuse
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserEmail() {
      return request.auth.token.email;
    }
    
    function isOwner(userId) {
      return isSignedIn() && getUserEmail() == userId;
    }
    
    // User profiles collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if true;
      
      // Allow authenticated users to create profiles
      allow create: if isSignedIn();
      
      // Only the user can update or delete their own profile, 
      // or users can add/remove themselves from followers/following lists
      // or update follow requests
      allow update: if isSignedIn() && 
                     (
                       // Owner can do anything to their profile
                       getUserEmail() == userId || 
                       
                       // Follower operations
                       (request.resource.data.followers.hasOnly(resource.data.followers.concat([getUserEmail()])) ||
                        resource.data.followers.hasOnly(request.resource.data.followers.concat([getUserEmail()]))) ||
                       
                       // Follow request operations - adding or removing from received requests
                       (request.resource.data.followRequestsReceived.hasOnly(resource.data.followRequestsReceived.concat([getUserEmail()])) ||
                        resource.data.followRequestsReceived.hasOnly(request.resource.data.followRequestsReceived.concat([getUserEmail()]))) ||
                       
                       // Allow modification of sent requests if target user is current user
                       (request.resource.data.followRequestsSent.hasOnly(resource.data.followRequestsSent.concat([getUserEmail()])) ||
                        resource.data.followRequestsSent.hasOnly(request.resource.data.followRequestsSent.concat([getUserEmail()])))
                     );
                     
      allow delete: if isOwner(userId);
      
      // Users collection has subcollections
      match /private/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Trips collection
    match /alltrips/{tripId} {
      // Public trips can be read by anyone, or creator can read their own trips
      allow read: if true; // Temporarily allow all reads for testing
      
      // Allow any authenticated user to create trips
      allow create: if isSignedIn();
      
      // Allow updating if user is signed in and either:
      // 1. Modifying only allowed social fields (likes, comments)
      // 2. Is the original creator
      allow update: if isSignedIn() && (
        request.resource.data.diff(resource.data).affectedKeys().hasAny(['likedBy', 'likesCount', 'commentCount']) ||
        resource.data.userEmail == getUserEmail()
      );
      
      // Only the creator can delete their trips
      allow delete: if isSignedIn() && resource.data.userEmail == getUserEmail();
    }
    
    // Likes collection
    match /likes/{likeId} {
      // Anyone can read likes
      allow read: if true;
      
      // Only authenticated users can create/update likes
      allow create, update: if isSignedIn();
      allow delete: if isSignedIn() && 
                      (resource.data.userEmail == getUserEmail() || 
                       get(/databases/$(database)/documents/alltrips/$(resource.data.contentId)).data.userEmail == getUserEmail());
    }
    
    // Comments collection
    match /comments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      
      // Anyone can create comments (temporary solution for testing)
      allow create: if isSignedIn() || 
                (request.resource.data.userEmail != null && 
                 request.resource.data.text != null &&
                 !request.resource.data.text.matches('.*[<>].*'));
      
      // Only the comment owner or the content owner can delete comments
      allow update, delete: if isSignedIn() && 
                             (resource.data.userEmail == getUserEmail() || 
                              get(/databases/$(database)/documents/alltrips/$(resource.data.tripId)).data.userEmail == getUserEmail());
    }
    
    // Shares collection (analytics)
    match /shares/{shareId} {
      // Anyone can read share analytics
      allow read: if true;
      
      // Only authenticated users can record shares
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // Follower relationships
    match /followers/{followId} {
      // Follower relationships can be read by anyone
      allow read: if true;
      
      // Only authenticated users can create/modify follow relationships
      allow create, update, delete: if isSignedIn();
    }
    
    // Conversations collection for chat
    match /conversations/{conversationId} {
      // Only conversation participants can read/write to their conversations
      allow read, write: if isSignedIn() && getUserEmail() in resource.data.participants;
      
      // Allow users to create conversations with themselves as a participant
      allow create: if isSignedIn() && getUserEmail() in request.resource.data.participants;
      
      // Messages subcollection within conversations
      match /messages/{messageId} {
        // Only conversation participants can read/write messages
        allow read, write: if isSignedIn() && 
                           getUserEmail() in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
